---
import Layout from '../layouts/Layout.astro';
import Hero from '../components/Hero.astro';
import IntroSection from '../components/IntroSection.astro';
import ProblemIASection from '../components/ProblemIASection.astro';
import ServicesIASection from '../components/ServicesIASection.astro';
import QuoteSection from '../components/QuoteSection.astro';
import WhyIANowSection from '../components/WhyIANowSection.astro';
import ExamplesIASection from '../components/ExamplesUltraSimple.astro';
import MethodologyIASection from '../components/MethodologyIASection.astro';
import CasesIASection from '../components/CasesIASection.astro';
import FAQSection from '../components/FAQSection.astro';
import GravityFormSection from '../components/GravityFormSection.astro';

// [Todo el c√≥digo de GraphQL se mantiene igual...]
// Query para obtener tanto la p√°gina de inicio como el icono del sitio
const GQL = `
  query GetHomePageAndSiteIcon {
    page(id: "/", idType: URI) {
      title
      content
      databaseId
      featuredImage {
        node {
          sourceUrl
          altText
          mediaDetails {
            width
            height
          }
        }
      }
      seo {
        title
        metaDesc
        opengraphTitle
        opengraphDescription
      }
    }
    generalSettings {
      title
      description
      url
    }
    # Buscar el logo de BLIXEL
    mediaItems(where: {search: "BLIXEL"}, first: 5) {
      nodes {
        id
        title
        sourceUrl
        altText
        mediaDetails {
          width
          height
        }
      }
    }
  }
`;

// Datos por defecto en caso de error
let home = null;
let siteSettings = {
  title: 'Inteligencia Artificial para Empresas | Blixel',
  description: 'Implementamos soluciones de IA para empresas con ROI garantizado en 90 d√≠as.',
  url: 'https://blixel.es'
};
let mediaItems = [];
let buildStatus = 'fallback';

// Intentar GraphQL si la URL est√° configurada
const graphqlUrl = import.meta.env.PUBLIC_WP_GRAPHQL_URL;
const isDev = import.meta.env.DEV;

if (graphqlUrl) {
  try {
    console.log('üîç [INDEX] Probando conexi√≥n GraphQL:', graphqlUrl);
    
    const res = await fetch(graphqlUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query: GQL })
    });

    if (res.ok) {
      const result = await res.json();
      console.log('‚úÖ [INDEX] GraphQL Response:', result);
      
      // Si no hay errores y tenemos data
      if (!result.errors && result.data) {
        home = result.data.page;
        siteSettings = result.data.generalSettings || siteSettings;
        mediaItems = result.data.mediaItems?.nodes || [];
        buildStatus = 'success';
      } else {
        console.warn('‚ö†Ô∏è [INDEX] GraphQL response tiene errores:', result.errors);
      }
    } else {
      console.warn(`‚ö†Ô∏è [INDEX] Error HTTP: ${res.status} al acceder a ${graphqlUrl}`);
    }
    
  } catch (error) {
    console.warn('‚ö†Ô∏è [INDEX] Error de conexi√≥n GraphQL (usando fallback):', error.message);
  }
} else {
  console.log('‚ÑπÔ∏è [INDEX] GraphQL URL no configurada');
}

// Buscar el logo de BLIXEL
let siteIcon = mediaItems.find(item => 
  item.title?.toLowerCase().includes('logo') && 
  item.title?.toLowerCase().includes('blixel')
) || mediaItems.find(item => 
  item.sourceUrl?.includes('logo') || 
  item.altText?.toLowerCase().includes('logo')
) || mediaItems[0];

// Si no encuentra nada, usar la URL que sabemos que existe
if (!siteIcon) {
  siteIcon = {
    sourceUrl: 'https://cms.blixel.es/wp-content/uploads/2025/05/cropped-Copia-de-BLIXEL-STUDIO_logo-500500.png',
    altText: 'BLIXEL logo',
    mediaDetails: { width: 512, height: 512 }
  };
}

// Datos del logo para pasar al Layout
const logoData = {
  url: siteIcon.sourceUrl,
  alt: siteIcon.altText || 'BLIXEL logo',
  width: siteIcon.mediaDetails?.width || 512,
  height: siteIcon.mediaDetails?.height || 512
};

// Extraer datos SEO para el metadata
const pageTitle = home?.seo?.title || home?.seo?.opengraphTitle || home?.title || siteSettings?.title || 'Inteligencia Artificial para Empresas | Blixel';
const pageDescription = home?.seo?.metaDesc || home?.seo?.opengraphDescription || siteSettings?.description || 'Implementamos soluciones de IA para empresas con ROI garantizado en 90 d√≠as. Automatizaci√≥n, agentes inteligentes y formaci√≥n especializada.';

// Extraer imagen destacada para Open Graph
const featuredImage = home?.featuredImage?.node?.sourceUrl || null;
const featuredImageAlt = home?.featuredImage?.node?.altText || pageTitle;

// El t√≠tulo H1 ser√° el t√≠tulo de la p√°gina de WordPress (no el SEO title)
const h1Title = home?.title || 'Inteligencia Artificial para Empresas';

// Dividir el t√≠tulo en dos l√≠neas de forma m√°s inteligente
// Buscar si hay un signo de interrogaci√≥n para dividir ah√≠
let titleLine1, titleLine2;
if (h1Title.includes('?')) {
  const parts = h1Title.split('?');
  titleLine1 = parts[0] + '?';
  titleLine2 = parts[1].trim();
} else {
  // Si no hay signo de interrogaci√≥n, dividir por la mitad
  const words = h1Title.split(' ');
  const midPoint = Math.ceil(words.length / 2);
  titleLine1 = words.slice(0, midPoint).join(' ');
  titleLine2 = words.slice(midPoint).join(' ');
}
---

<Layout 
  logoUrl={logoData.url} 
  logoAlt={logoData.alt}
  title={pageTitle}
  description={pageDescription}
  ogImage={featuredImage}
  ogImageAlt={featuredImageAlt}
>
  <main>
    <!-- Hero independiente (no es section) -->
    <Hero 
      pageSlug="/" 
      customTitle={h1Title}
      customDescription={pageDescription}
      titleLine1={titleLine1}
      titleLine2={titleLine2}
      logoUrl={logoData.url}
      logoAlt={logoData.alt}
    />

    <!-- SECCI√ìN 1: Propuesta de Valor -->
    <section id="propuesta-valor" class="main-section" aria-labelledby="propuesta-heading">
      <h2 id="propuesta-heading" class="sr-only">Nuestra propuesta de valor en IA</h2>
      
      <div class="subsection">
        <ServicesIASection />
      </div>
      
      <aside class="quote-wrapper">
        <QuoteSection />
      </aside>
      
      <div class="subsection">
        <WhyIANowSection />
      </div>
    </section>

    <!-- SECCI√ìN 2: Demostraci√≥n y Casos -->
    <section id="demostracion" class="main-section" aria-labelledby="demo-heading">
      <h2 id="demo-heading" class="sr-only">Casos de √©xito y metodolog√≠a</h2>
      
      <div class="subsection">
        <ExamplesIASection />
      </div>
      
      <div class="subsection">
        <MethodologyIASection />
      </div>
      
      <div class="subsection">
        <CasesIASection />
      </div>
    </section>

    <!-- SECCI√ìN 3: Informaci√≥n y Recursos -->
    <section id="recursos" class="main-section" aria-labelledby="recursos-heading">
      <h2 id="recursos-heading" class="sr-only">Informaci√≥n sobre IA empresarial</h2>
      
      <article class="info-article">
        <IntroSection />
      </article>
      
      <div class="subsection">
        <ProblemIASection />
      </div>
      
      <div class="subsection faq-wrapper">
        <FAQSection />
      </div>
    </section>

    <!-- SECCI√ìN 4: Contacto -->
    <section id="contacto" class="main-section contact-section" aria-labelledby="contacto-heading">
      <h2 id="contacto-heading" class="sr-only">Solicita tu diagn√≥stico</h2>
      <GravityFormSection 
        title="Solicita tu Diagn√≥stico de IA para Empresas"
        description="Obt√©n un an√°lisis personalizado de c√≥mo la inteligencia artificial puede transformar tu empresa. Sin compromiso, con resultados medibles en 90 d√≠as."
        showTrustBadges={true}
      />
    </section>
  </main>
</Layout>

<style>
  /* Estilos para estructura sem√°ntica mejorada */
  main {
    background: #000000;
    color: #e5e5e5;
  }

  /* Secciones principales con m√°s espacio */
  .main-section {
    padding: 2rem 0;
    position: relative;
  }

  /* Subsecciones sin tanto padding */
  .subsection {
    margin: 2rem 0;
  }

  /* Elementos espec√≠ficos */
  .quote-wrapper {
    margin: 3rem 0;
  }

  .info-article {
    margin: 2rem 0;
  }

  .faq-wrapper {
    margin-top: 3rem;
  }

  .contact-section {
    padding-top: 4rem;
    padding-bottom: 4rem;
  }

  /* Screen reader only - para accesibilidad */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }

  /* Eliminar estilos de section globales agresivos */
  :global(section section) {
    padding: 0 !important;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .main-section {
      padding: 1.5rem 0;
    }

    .subsection {
      margin: 1.5rem 0;
    }
  }

  /* Smooth scroll */
  :global(html) {
    scroll-behavior: smooth;
  }

  /* Optimizaci√≥n de fuentes */
  :global(body) {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  :global(h1, h2, h3, h4, h5, h6) {
    font-family: 'Inter Tight', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Intersection Observer solo para las 4 secciones principales
  const mainSections = document.querySelectorAll('.main-section');
  
  if ('IntersectionObserver' in window) {
    const sectionObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('in-view');
          
          // Track secci√≥n vista (menos eventos)
          const sectionId = entry.target.id;
          if (typeof gtag !== 'undefined' && sectionId) {
            gtag('event', 'section_view', {
              'section_name': sectionId
            });
          }
        }
      });
    }, { threshold: 0.3 });

    mainSections.forEach(section => {
      sectionObserver.observe(section);
    });
  }

  // Smooth scroll simplificado
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
      e.preventDefault();
      const targetId = this.getAttribute('href');
      const target = document.querySelector(targetId);
      if (target) {
        target.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    });
  });
});
</script>
