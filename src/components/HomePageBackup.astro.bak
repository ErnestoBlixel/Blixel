---
import { request } from 'graphql-request';

// Funci√≥n para decodificar HTML entities
function decodeHtmlEntities(text: string): string {
  const entities: { [key: string]: string } = {
    '&amp;': '&',
    '&lt;': '<',
    '&gt;': '>',
    '&quot;': '"',
    '&#39;': "'",
    '&#8211;': '‚Äì', // En dash
    '&#8212;': '‚Äî', // Em dash
    '&#8216;': ''', // Left single quotation mark
    '&#8217;': ''', // Right single quotation mark
    '&#8220;': '"', // Left double quotation mark
    '&#8221;': '"', // Right double quotation mark
    '&#8230;': '‚Ä¶', // Horizontal ellipsis
  };
  
  return text.replace(/&[#\w]+;/g, (entity) => {
    return entities[entity] || entity;
  });
}

// URLs de GraphQL para probar
const endpoints = [
  'https://blixel.es/graphql',
  'https://blixel.es/wp-json/graphql',
  'https://www.blixel.es/graphql'
];

let siteTitle = "Blixel";
let siteDescription = "";
let homeContent = "";
let homeTitle = "";
let workingEndpoint = null;

// Query GraphQL para obtener informaci√≥n del sitio y contenido de la home
const query = `
  query GetHomePageContent {
    generalSettings {
      title
      description
    }
    page(id: "home", idType: URI) {
      id
      title
      content
      slug
    }
  }
`;

// Query de respaldo para buscar p√°ginas
const fallbackQuery = `
  query GetHomePageFallback {
    generalSettings {
      title
      description
    }
    pages(where: {name: "home"}, first: 1) {
      nodes {
        id
        title
        content
        slug
      }
    }
  }
`;

// Intentar conectar con cada endpoint
for (const endpoint of endpoints) {
  try {
    console.log(`üîÑ Intentando conexi√≥n con: ${endpoint}`);
    
    const response = await request(endpoint, query);
    
    if (response.generalSettings) {
      workingEndpoint = endpoint;
      console.log(`‚úÖ Conexi√≥n exitosa con: ${endpoint}`);
      
      // Procesar datos del sitio
      siteTitle = decodeHtmlEntities(response.generalSettings.title || "Blixel");
      siteDescription = decodeHtmlEntities(response.generalSettings.description || "");
      
      // Procesar contenido de la p√°gina home
      if (response.page) {
        homeTitle = decodeHtmlEntities(response.page.title || siteTitle);
        homeContent = response.page.content || "";
      } else {
        // Intentar query de respaldo
        try {
          const fallbackResponse = await request(endpoint, fallbackQuery);
          if (fallbackResponse.pages?.nodes?.[0]) {
            const page = fallbackResponse.pages.nodes[0];
            homeTitle = decodeHtmlEntities(page.title || siteTitle);
            homeContent = page.content || "";
          }
        } catch (fallbackError) {
          console.log('‚ö†Ô∏è Fallback query tambi√©n fall√≥');
        }
      }
      
      break; // Salir del bucle si encontramos un endpoint que funciona
    }
    
  } catch (error) {
    console.log(`‚ùå Error con ${endpoint}:`, error.message);
    continue; // Intentar con el siguiente endpoint
  }
}

// Si no hay contenido espec√≠fico de home, usar descripci√≥n del sitio
if (!homeContent && siteDescription) {
  homeContent = `<p>${siteDescription}</p>`;
} else if (!homeContent) {
  homeContent = `
    <div class="welcome-content">
      <h2>Bienvenido a Blixel</h2>
      <p>Estudio de dise√±o gr√°fico y desarrollo web especializado en automatizaci√≥n empresarial con IA.</p>
      <p>Estamos trabajando para conectar con nuestro contenido desde WordPress. Por favor, int√©ntalo de nuevo en unos momentos.</p>
    </div>
  `;
}

// Si no tenemos t√≠tulo de home, usar el del sitio
if (!homeTitle) {
  homeTitle = siteTitle;
}

const { className = 'home-page' } = Astro.props;
---

<div class={className}>
  <header>
    <h1>{homeTitle}</h1>
    {workingEndpoint && (
      <p class="connection-status success">‚úÖ Conectado a {workingEndpoint}</p>
    )}
    {!workingEndpoint && (
      <p class="connection-status error">‚ö†Ô∏è Modo sin conexi√≥n - Usando contenido de respaldo</p>
    )}
  </header>
  
  <main>
    <div class="content" set:html={homeContent}></div>
  </main>
</div>

<style>
  .home-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }
  
  header {
    text-align: center;
    margin-bottom: 3rem;
  }
  
  header h1 {
    color: #2c3e50;
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .connection-status {
    font-size: 0.9rem;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    margin: 1rem 0;
    font-weight: 500;
  }
  
  .connection-status.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }
  
  .connection-status.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
  
  main {
    line-height: 1.7;
    font-size: 1.125rem;
  }
  
  .content {
    max-width: 800px;
    margin: 0 auto;
  }
  
  .welcome-content {
    text-align: center;
    padding: 3rem 2rem;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    border-radius: 1rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  }
  
  .welcome-content h2 {
    color: #2c3e50;
    font-size: 2rem;
    margin-bottom: 1.5rem;
    font-weight: 600;
  }
  
  .welcome-content p {
    color: #5a6c7d;
    font-size: 1.125rem;
    margin-bottom: 1rem;
    line-height: 1.6;
  }
  
  /* Estilos para el contenido de WordPress */
  :global(.home-page .content p) {
    margin-bottom: 1.5rem;
    color: #4a5568;
  }
  
  :global(.home-page .content h2) {
    color: #2d3748;
    font-size: 2rem;
    margin: 3rem 0 1.5rem 0;
    font-weight: 600;
  }
  
  :global(.home-page .content h3) {
    color: #4a5568;
    font-size: 1.5rem;
    margin: 2rem 0 1rem 0;
    font-weight: 500;
  }
  
  :global(.home-page .content img) {
    max-width: 100%;
    height: auto;
    border-radius: 12px;
    margin: 2rem 0;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  }
  
  :global(.home-page .content ul, .home-page .content ol) {
    margin: 1.5rem 0;
    padding-left: 2rem;
  }
  
  :global(.home-page .content li) {
    margin-bottom: 0.5rem;
    color: #4a5568;
  }
  
  :global(.home-page .content blockquote) {
    border-left: 4px solid #667eea;
    margin: 2rem 0;
    padding: 1.5rem 2rem;
    background: linear-gradient(135deg, #f8faff 0%, #f0f4ff 100%);
    border-radius: 0 12px 12px 0;
    font-style: italic;
    color: #4a5568;
  }
  
  :global(.home-page .content a) {
    color: #667eea;
    text-decoration: none;
    border-bottom: 2px solid transparent;
    transition: border-color 0.3s ease;
  }
  
  :global(.home-page .content a:hover) {
    border-bottom-color: #667eea;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .home-page {
      padding: 1rem;
    }
    
    header h1 {
      font-size: 2rem;
    }
    
    main {
      font-size: 1rem;
    }
    
    .welcome-content {
      padding: 2rem 1rem;
    }
    
    .welcome-content h2 {
      font-size: 1.5rem;
    }
    
    .connection-status {
      font-size: 0.8rem;
    }
  }
</style>
