---
interface Props {
  formId: number;
  title?: string;
  description?: string;
  className?: string;
}

const { formId, title, description, className = '' } = Astro.props;

// URL base de WordPress
const wpBaseUrl = import.meta.env.PUBLIC_WP_GRAPHQL_URL?.replace('/graphql', '') || 'https://cms.blixel.es';

// Funci√≥n para obtener el HTML del formulario desde WordPress
let formHTML = '';
let formError = '';

try {
  // M√©todo 1: Usar la API REST de WordPress para ejecutar el shortcode
  const shortcodeUrl = `${wpBaseUrl}/wp-json/wp/v2/render-shortcode`;
  const shortcodeBody = {
    shortcode: `[gravityform id="${formId}" title="false" description="false" ajax="true"]`
  };

  const response = await fetch(shortcodeUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(shortcodeBody)
  });

  if (response.ok) {
    const result = await response.json();
    formHTML = result.rendered || '';
  } else {
    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
  }

} catch (error) {
  console.warn('‚ö†Ô∏è Error obteniendo formulario via shortcode:', error.message);
  formError = error.message;
  
  // Fallback: HTML b√°sico del formulario
  formHTML = `
    <div class="gravity-form-fallback">
      <p style="text-align: center; margin-bottom: 2rem; color: #a0a0a0;">
        Cargando formulario de diagn√≥stico...
      </p>
      <div class="form-fallback-content">
        <p><strong>Mientras tanto, puedes contactarnos directamente:</strong></p>
        <ul style="list-style: none; padding: 0;">
          <li>üìß Email: <a href="mailto:info@blixel.es" style="color: #02aa6d;">info@blixel.es</a></li>
          <li>üìû Tel√©fono: <a href="tel:+34600000000" style="color: #02aa6d;">+34 600 000 000</a></li>
          <li>üåê Web: <a href="${wpBaseUrl}" target="_blank" style="color: #02aa6d;">Sitio principal</a></li>
        </ul>
      </div>
    </div>
  `;
}
---

<section class={`gravity-form-shortcode-section ${className}`} id="diagnostico-form-shortcode">
  <div class="container">
    {title && (
      <div class="form-header">
        <h2 class="form-title">{title}</h2>
        {description && <p class="form-description">{description}</p>}
      </div>
    )}
    
    <div class="form-container">
      <div class="form-content" set:html={formHTML}></div>
      
      {formError && (
        <div class="form-error">
          <p>‚ö†Ô∏è Error de conexi√≥n. <a href={`${wpBaseUrl}/contact`} target="_blank">Contactar directamente</a></p>
        </div>
      )}
    </div>
  </div>
</section>

<style>
  .gravity-form-shortcode-section {
    background: #000000;
    padding: 4rem 0;
    color: #e5e5e5;
  }

  .container {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .form-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .form-title {
    font-size: 2.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, #02aa6d 0%, #0ea5e9 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 1rem;
    line-height: 1.2;
  }

  .form-description {
    font-size: 1.125rem;
    color: #a0a0a0;
    max-width: 600px;
    margin: 0 auto;
    line-height: 1.6;
  }

  .form-container {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 16px;
    padding: 2rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  }

  .form-content {
    min-height: 400px;
  }

  /* Estilos para el formulario de Gravity Forms */
  .form-content :global(.gform_wrapper) {
    background: #ffffff;
    padding: 2rem;
    border-radius: 12px;
    color: #333333;
  }

  .form-content :global(.gform_wrapper .gform_title) {
    display: none; /* Ocultamos el t√≠tulo del formulario ya que lo mostramos arriba */
  }

  .form-content :global(.gform_wrapper .gform_description) {
    display: none; /* Ocultamos la descripci√≥n del formulario */
  }

  .form-content :global(.gform_wrapper .gfield_label) {
    font-weight: 600;
    color: #333333;
    margin-bottom: 0.5rem;
  }

  .form-content :global(.gform_wrapper input[type="text"]),
  .form-content :global(.gform_wrapper input[type="email"]),
  .form-content :global(.gform_wrapper input[type="tel"]),
  .form-content :global(.gform_wrapper select),
  .form-content :global(.gform_wrapper textarea) {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
  }

  .form-content :global(.gform_wrapper input:focus),
  .form-content :global(.gform_wrapper select:focus),
  .form-content :global(.gform_wrapper textarea:focus) {
    outline: none;
    border-color: #02aa6d;
    box-shadow: 0 0 0 3px rgba(2, 170, 109, 0.1);
  }

  .form-content :global(.gform_wrapper .gform_button) {
    background: linear-gradient(135deg, #02aa6d 0%, #0ea5e9 100%);
    color: white;
    padding: 1rem 2rem;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .form-content :global(.gform_wrapper .gform_button:hover) {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(2, 170, 109, 0.3);
  }

  .gravity-form-fallback {
    background: #ffffff;
    padding: 2rem;
    border-radius: 12px;
    color: #333333;
    text-align: center;
  }

  .form-fallback-content {
    text-align: left;
    max-width: 400px;
    margin: 0 auto;
  }

  .form-fallback-content ul li {
    padding: 0.5rem 0;
  }

  .form-error {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
    text-align: center;
    color: #ef4444;
  }

  .form-error a {
    color: #02aa6d;
    text-decoration: underline;
  }

  /* Estilos responsivos */
  @media (max-width: 768px) {
    .gravity-form-shortcode-section {
      padding: 2rem 0;
    }

    .form-title {
      font-size: 2rem;
    }

    .form-container {
      padding: 1rem;
      border-radius: 12px;
    }

    .form-content :global(.gform_wrapper) {
      padding: 1rem;
    }
  }

  @media (max-width: 480px) {
    .form-title {
      font-size: 1.75rem;
    }

    .form-description {
      font-size: 1rem;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const formContent = document.querySelector('.form-content');
    
    if (formContent) {
      // Verificar si Gravity Forms se carg√≥ correctamente
      const gravityForm = formContent.querySelector('.gform_wrapper');
      
      if (gravityForm) {
        console.log('‚úÖ Formulario Gravity Forms cargado via shortcode');
        
        // Agregar eventos espec√≠ficos de Gravity Forms
        const submitBtn = gravityForm.querySelector('.gform_button');
        if (submitBtn) {
          submitBtn.addEventListener('click', function() {
            console.log('üìù Formulario enviado');
            
            // Analytics tracking
            if (typeof gtag !== 'undefined') {
              gtag('event', 'form_submit', {
                'event_category': 'engagement',
                'event_label': 'Gravity Forms - Diagn√≥stico IA'
              });
            }
          });
        }
      } else {
        console.log('‚ö†Ô∏è Formulario no encontrado, mostrando fallback');
      }
    }

    // Mejorar accesibilidad
    const inputs = document.querySelectorAll('.form-content input, .form-content select, .form-content textarea');
    inputs.forEach(input => {
      input.addEventListener('focus', function() {
        this.parentElement?.classList.add('focused');
      });
      
      input.addEventListener('blur', function() {
        this.parentElement?.classList.remove('focused');
      });
    });
  });
</script>
