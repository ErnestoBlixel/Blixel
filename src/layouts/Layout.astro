---
import ThemeToggle from '../components/ThemeToggle.astro';
import '../styles/globals.css';
import '../styles/light-mode-override.css';
// import MagicNotifications from '../components/MagicNotifications.astro'; // Removed during cleanup

export interface Props {
  title?: string;
  description?: string;
  className?: string;
  logoUrl?: string;
  logoAlt?: string;
  ogImage?: string;
  ogImageAlt?: string;
}

// Obtener información del sitio para meta tags
let siteTitle = "Blixel";
let siteDescription = "Automatiza tu empresa con IA";

// COMENTADO: Este fetch puede causar problemas de recursión
// try {
//   const baseResponse = await fetch('https://blixel.es/wp-json/');
//   if (baseResponse.ok) {
//     const baseData = await baseResponse.json();
//     if (baseData.name) {
//       siteTitle = baseData.name;
//     }
//     if (baseData.description) {
//       siteDescription = baseData.description;
//     }
//   }
// } catch (error) {
//   // Usar valores por defecto si hay error
// }

const { 
  title = siteTitle, 
  description = siteDescription,
  className = '',
  logoUrl,
  logoAlt,
  ogImage,
  ogImageAlt = title
} = Astro.props;

// Construir título completo
const fullTitle = title === siteTitle ? siteTitle : `${title} | ${siteTitle}`;
---

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{fullTitle}</title>
  <meta name="description" content={description}>
  
  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🚀</text></svg>">
  
  <!-- Meta tags adicionales -->
  <meta name="robots" content="index, follow">
  <meta name="author" content="Blixel">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:title" content={fullTitle}>
  <meta property="og:description" content={description}>
  <meta property="og:url" content="https://blixel.es">
  {ogImage && <meta property="og:image" content={ogImage} />}
  {ogImage && <meta property="og:image:alt" content={ogImageAlt} />}
  <meta property="og:site_name" content={siteTitle}>
  <meta property="og:locale" content="es_ES">
  
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content={fullTitle}>
  <meta name="twitter:description" content={description}>
  {ogImage && <meta name="twitter:image" content={ogImage} />}
  {ogImage && <meta name="twitter:image:alt" content={ogImageAlt} />}
  
  <!-- Preload fonts for better performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body class={className}>
  <!-- Botón de cambio de tema -->
  <ThemeToggle />
  
  <!-- Canvas de partículas modernas con tsParticles -->
  <div id="tsparticles"></div>
  
  <!-- Header removido para usar el de WordPress -->
  
  <!-- Contenido principal -->
  <main id="main-content">
    <slot />
  </main>
  
  <!-- Magic UI Notifications System -->
  <!-- MagicNotifications component removed during cleanup -->
  
  <!-- Sistema de partículas modernas con tsParticles -->
  <script>
    // Función para cargar tsParticles modernos y minimalistas
    async function loadTsParticles() {
      // Cargar tsParticles desde CDN
      if (!window.tsParticles) {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/tsparticles-slim@2.12.0/tsparticles.slim.bundle.min.js';
        script.onload = initTsParticles;
        document.head.appendChild(script);
      } else {
        initTsParticles();
      }
    }

    // Configuración minimalista y moderna de tsParticles
    function initTsParticles() {
      tsParticles.load('tsparticles', {
        background: {
          color: {
            value: 'transparent',
          },
        },
        fpsLimit: 120,
        interactivity: {
          events: {
            onClick: {
              enable: true,
              mode: 'push',
            },
            onHover: {
              enable: true,
              mode: 'repulse',
            },
            resize: true,
          },
          modes: {
            push: {
              quantity: 2,
            },
            repulse: {
              distance: 80,
              duration: 0.4,
            },
          },
        },
        particles: {
          color: {
            value: document.documentElement.classList.contains('dark') 
              ? ['#60a5fa', '#3b82f6', '#2563eb']
              : ['#3b82f6', '#1e40af', '#1d4ed8'],
          },
          links: {
            color: document.documentElement.classList.contains('dark') ? '#60a5fa' : '#3b82f6',
            distance: 100,
            enable: true,
            opacity: document.documentElement.classList.contains('dark') ? 0.08 : 0.12,
            width: 1,
          },
          collisions: {
            enable: false,
          },
          move: {
            direction: 'none',
            enable: true,
            outModes: {
              default: 'bounce',
            },
            random: false,
            speed: 0.3,
            straight: false,
          },
          number: {
            density: {
              enable: true,
              area: 1500,
            },
            value: 25,
          },
          opacity: {
            value: document.documentElement.classList.contains('dark') ? 0.15 : 0.25,
            animation: {
              enable: true,
              speed: 0.8,
              minimumValue: document.documentElement.classList.contains('dark') ? 0.05 : 0.1,
              sync: false,
            },
          },
          shape: {
            type: 'circle',
          },
          size: {
            value: { min: 1, max: 2.5 },
            animation: {
              enable: true,
              speed: 1.5,
              minimumValue: 0.3,
              sync: false,
            },
          },
        },
        detectRetina: true,
      });
    }

    // Función para actualizar partículas según el tema
    function updateParticlesTheme() {
      if (window.tsParticles && window.tsParticles.domItem(0)) {
        const isDark = document.documentElement.classList.contains('dark');
        const container = window.tsParticles.domItem(0);
        
        // Actualizar colores de partículas
        container.options.particles.color.value = isDark 
          ? ['#60a5fa', '#3b82f6', '#2563eb']
          : ['#3b82f6', '#1e40af', '#1d4ed8'];
        
        // Actualizar enlaces
        container.options.particles.links.color = isDark ? '#60a5fa' : '#3b82f6';
        container.options.particles.links.opacity = isDark ? 0.08 : 0.12;
        
        // Actualizar opacidad
        container.options.particles.opacity.value = isDark ? 0.15 : 0.25;
        container.options.particles.opacity.animation.minimumValue = isDark ? 0.05 : 0.1;
        
        // Refrescar partículas
        container.refresh();
      }
    }

    // Observar cambios en el tema
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          updateParticlesTheme();
        }
      });
    });

    // Cargar al inicio
    document.addEventListener('DOMContentLoaded', () => {
      loadTsParticles();
      // Observar cambios en la clase del HTML
      observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class']
      });
    });
  </script>
</body>
</html>

<style is:global>
  /* Reset básico */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  html {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    scroll-behavior: smooth;
    scroll-padding-top: 100px; /* Espacio extra para el header fijo */
  }

  body {
    line-height: 1.6;
    color: #e5e5e5;
    background-color: #000000;
    overflow-x: hidden;
    padding-top: 0; /* Sin header */
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  /* Modo claro */
  html:not(.dark) body {
    color: #1a1a1a;
    background-color: #ffffff;
  }

  /* Layout principal */
  #main-content {
    min-height: calc(100vh - 200px);
  }



  /* Utilidades globales */
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  .text-center {
    text-align: center;
  }

  .mb-2 { margin-bottom: 1rem; }
  .mb-4 { margin-bottom: 2rem; }
  .mt-2 { margin-top: 1rem; }
  .mt-4 { margin-top: 2rem; }

  /* Canvas de partículas modernas tsParticles */
  #tsparticles {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    background: linear-gradient(135deg, #000000 0%, #0a0a0a 50%, #000000 100%);
    pointer-events: none;
    transition: background 0.5s ease;
  }

  /* Fondo para modo claro */
  html:not(.dark) #tsparticles {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
  }

  body {
    position: relative;
  }

  /* El contenido principal debe bloquear eventos del canvas */
  #main-content {
    pointer-events: auto;
    position: relative;
  }

  /* Asegurar fondo uniforme en todas las secciones */
  section {
    position: relative;
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
  }

  /* Main content transparente */
  #main-content {
    position: relative;
    background: transparent;
    z-index: 1;
  }




</style>
