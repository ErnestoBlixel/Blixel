---
import ThemeToggle from '../components/ThemeToggle.astro';
import CookieBanner from '../components/CookieBanner.astro';
import LanguageSelector from '../components/LanguageSelector.astro';
import SEOHead from '../components/SEOHead.astro';
import { getLangFromUrl } from '../i18n/config';
import '../styles/globals.css';
import '../styles/light-mode-override.css';

export interface Props {
  title?: string;
  description?: string;
  keywords?: string;
  className?: string;
  logoUrl?: string;
  logoAlt?: string;
  ogImage?: string;
  ogImageAlt?: string;
  pageKey?: string;
  type?: 'website' | 'article';
  publishedTime?: string;
  modifiedTime?: string;
  author?: string;
}

const { 
  title,
  description,
  keywords,
  className = '',
  logoUrl,
  logoAlt,
  ogImage,
  ogImageAlt,
  pageKey = 'home',
  type = 'website',
  publishedTime,
  modifiedTime,
  author
} = Astro.props;

// Obtener idioma actual
const currentLang = getLangFromUrl(Astro.url);
---

<!DOCTYPE html>
<html lang={currentLang === 'ca' ? 'ca-ES' : 'es-ES'}>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- SEO Head multiidioma -->
  <SEOHead 
    title={title}
    description={description}
    keywords={keywords}
    image={ogImage}
    imageAlt={ogImageAlt}
    type={type}
    publishedTime={publishedTime}
    modifiedTime={modifiedTime}
    author={author}
    currentUrl={Astro.url}
    pageKey={pageKey}
  />
  
  <!-- Preload fonts for better performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body class={className}>
  <!-- Bot√≥n de cambio de tema -->
  <ThemeToggle />
  
  <!-- Selector de idioma -->
  <LanguageSelector currentUrl={Astro.url} className="fixed top-4 right-20 z-50" />
  
  <!-- Banner de cookies RGPD -->
  <CookieBanner />
  
  <!-- Canvas de part√≠culas modernas con tsParticles -->
  <div id="tsparticles"></div>
  
  <!-- Header removido para usar el de WordPress -->
  
  <!-- Contenido principal -->
  <main id="main-content">
    <slot />
  </main>
  
  <!-- Magic UI Notifications System -->
  <!-- MagicNotifications component removed during cleanup -->
  
  <!-- Sistema de part√≠culas modernas con tsParticles -->
  <script>
    // Funci√≥n para cargar tsParticles modernos y minimalistas
    async function loadTsParticles() {
      // Cargar tsParticles desde CDN
      if (!window.tsParticles) {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/tsparticles-slim@2.12.0/tsparticles.slim.bundle.min.js';
        script.onload = initTsParticles;
        document.head.appendChild(script);
      } else {
        initTsParticles();
      }
    }

    // Configuraci√≥n minimalista y moderna de tsParticles
    function initTsParticles() {
      console.log('üéÜ Inicializando part√≠culas...');
      
      tsParticles.load('tsparticles', {
        background: {
          color: {
            value: 'transparent',
          },
        },
        fpsLimit: 120,
        interactivity: {
          events: {
            onClick: {
              enable: true,
              mode: 'push',
            },
            onHover: {
              enable: true,
              mode: 'grab',
            },
            resize: true,
          },
          modes: {
            push: {
              quantity: 4,
            },
            grab: {
              distance: 150,
              links: {
                opacity: 0.5,
              },
            },
          },
        },
        particles: {
          color: {
            value: ['#60a5fa', '#3b82f6', '#2563eb', '#93c5fd', '#1e40af'],
          },
          links: {
            color: '#60a5fa',
            distance: 150,
            enable: true,
            opacity: 0.25,
            width: 1,
          },
          collisions: {
            enable: false,
          },
          move: {
            direction: 'none',
            enable: true,
            outModes: {
              default: 'bounce',
            },
            random: false,
            speed: 0.8,
            straight: false,
          },
          number: {
            density: {
              enable: true,
              area: 1000,
            },
            value: 45,
          },
          opacity: {
            value: 0.4,
            animation: {
              enable: true,
              speed: 1,
              minimumValue: 0.1,
              sync: false,
            },
          },
          shape: {
            type: 'circle',
          },
          size: {
            value: { min: 1, max: 3 },
            animation: {
              enable: true,
              speed: 1.5,
              minimumValue: 0.5,
              sync: false,
            },
          },
        },
        detectRetina: true,
      }).then(() => {
        console.log('‚úÖ Part√≠culas cargadas correctamente');
      }).catch((error) => {
        console.error('‚ùå Error cargando part√≠culas:', error);
      });
    }

    // Funci√≥n para actualizar part√≠culas seg√∫n el tema
    function updateParticlesTheme() {
      if (window.tsParticles && window.tsParticles.domItem(0)) {
        const isDark = document.documentElement.classList.contains('dark');
        const container = window.tsParticles.domItem(0);
        
        // Actualizar colores de part√≠culas
        container.options.particles.color.value = isDark 
          ? ['#60a5fa', '#3b82f6', '#2563eb', '#93c5fd', '#1e40af'] // Modo oscuro: azules suaves
          : ['#1e293b', '#334155', '#475569', '#64748b', '#0f172a']; // Modo claro: grises oscuros
        
        // Actualizar enlaces
        container.options.particles.links.color = isDark ? '#60a5fa' : '#334155';
        container.options.particles.links.opacity = isDark ? 0.25 : 0.8;
        
        // Actualizar opacidad - MODO CLARO MUY VISIBLE
        container.options.particles.opacity.value = isDark ? 0.4 : 0.9;
        container.options.particles.opacity.animation.minimumValue = isDark ? 0.1 : 0.5;
        
        // Refrescar part√≠culas
        container.refresh();
        console.log(`üéÜ Part√≠culas ajustadas: ${isDark ? 'oscuro (suave)' : 'claro (visible)'}`);
      }
    }

    // Observar cambios en el tema
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          updateParticlesTheme();
        }
      });
    });

    // Cargar al inicio
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ DOM cargado, iniciando part√≠culas...');
      loadTsParticles();
      
      // Observar cambios en la clase del HTML
      observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class']
      });
      
      // Verificar si las part√≠culas est√°n cargadas despu√©s de 3 segundos
      setTimeout(() => {
        const particlesCanvas = document.querySelector('#tsparticles canvas');
        if (particlesCanvas) {
          console.log('‚úÖ Canvas de part√≠culas encontrado:', particlesCanvas);
          console.log('Dimensiones:', particlesCanvas.width, 'x', particlesCanvas.height);
        } else {
          console.error('‚ùå No se encontr√≥ el canvas de part√≠culas');
        }
      }, 3000);
    });
  </script>
</body>
</html>

<style is:global>
  /* Reset b√°sico */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  html {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    scroll-behavior: smooth;
    scroll-padding-top: 100px; /* Espacio extra para el header fijo */
  }

  body {
    line-height: 1.6;
    color: #e5e5e5;
    background-color: #000000;
    overflow-x: hidden;
    padding-top: 0; /* Sin header */
    transition: background-color 0.3s ease, color 0.3s ease;
    position: relative;
  }

  /* Modo claro */
  html:not(.dark) body {
    color: #1a1a1a;
    background-color: #ffffff;
  }

  /* Asegurar que el body tenga un fondo de gradiente */
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #000000 0%, #0a0a0a 50%, #000000 100%);
    z-index: -2;
    transition: background 0.5s ease;
  }

  html:not(.dark) body::before {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
  }

  /* Layout principal */
  #main-content {
    min-height: calc(100vh - 200px);
  }



  /* Utilidades globales */
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  .text-center {
    text-align: center;
  }

  .mb-2 { margin-bottom: 1rem; }
  .mb-4 { margin-bottom: 2rem; }
  .mt-2 { margin-top: 1rem; }
  .mt-4 { margin-top: 2rem; }

  /* Canvas de part√≠culas modernas tsParticles */
  #tsparticles {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    pointer-events: none;
    opacity: 1;
  }

  /* A√±adir canvas de tsparticles al contenedor */
  #tsparticles canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
  }

  body {
    position: relative;
  }

  /* El contenido principal debe bloquear eventos del canvas */
  #main-content {
    pointer-events: auto;
    position: relative;
  }

  /* Asegurar fondo uniforme en todas las secciones */
  section {
    position: relative;
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
  }

  /* Main content transparente */
  #main-content {
    position: relative;
    background: transparent;
    z-index: 10;
  }




</style>
